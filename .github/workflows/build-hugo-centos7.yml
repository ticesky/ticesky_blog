name: Build Hugo Extended for CentOS7

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (optional)
        uses: actions/checkout@v4

      - name: Build hugo inside CentOS7 container
        run: |
          docker run --rm \
            -v $PWD:/work \
            -w /work \
            centos:7 \
            bash -c "
              sed -i \
                -e 's|^mirrorlist=|#mirrorlist=|g' \
                -e 's|^#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' \
                /etc/yum.repos.d/CentOS-Base.repo && \
              yum clean all && yum makecache && \
              yum -y install gcc gcc-c++ git make wget && \

              wget https://go.dev/dl/go1.22.2.linux-amd64.tar.gz && \
              tar -C /usr/local -xzf go1.22.2.linux-amd64.tar.gz && \
              export PATH=/usr/local/go/bin:\$PATH && \
              export CGO_ENABLED=1 && \

              git clone https://github.com/gohugoio/hugo.git && \
              cd hugo && \
              git checkout v0.148.0 && \
              go build -tags extended && \
              cp hugo /work/hugo
            "

      - name: Check binary
        run: |
          file hugo
          ./hugo version || true

      - name: Upload hugo binary
        uses: actions/upload-artifact@v4
        with:
          name: hugo-centos7-extended
          path: hugo
